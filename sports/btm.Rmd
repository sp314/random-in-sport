---
title: "Information Content of Regular Season Games"
output: html_notebook
---

```{r setup, include=FALSE}
library(tidyverse)
library(lubridate)
library(BradleyTerry2)
library(prefmod)

nba <- read_csv(file = "data/nba.csv")
nfl <- read_csv(file = "data/nfl.csv")
nhl <- read_csv(file = "data/nhl.csv")
```

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: { equationNumbers: { autoNumber: "AMS" } }
});
</script>

### Initial BT Model
I restrict our sample to a single season of NBA for now and just run a simple Bradley-Terry for evaluating the strength parameters $\theta_s$ for all teams $s$ as well as the home field advantage regressor $\alpha$. This model is representative of (1) where $\pi_{i,j}$ is the probability $i$ (home) beats $j$ (away).

\begin{equation}
  \ln\left( \frac{\pi_{i,j}}{1 - \pi_{i,j}} \right) = \theta_i - \theta_j + \alpha
\end{equation}


```{r initial_bt}
nba_10 <- nba %>%
  filter(season == "2010-11") %>% 
  mutate(hfa = 1)

nba_10_model <- BTm(outcome = home_win, #1 if player1 (home) wins and 0 if player2 (away) does
    player1 = data.frame(team = home, hfa = 1, days_since_last_game = home_days_since_last_game), 
    player2 = data.frame(team = away, hfa = 0, days_since_last_game = away_days_since_last_game),
    formula = ~team + hfa + days_since_last_game, id = "team", data = nba_10)

nba_10_thetas.qv <- qvcalc(BTabilities(nba_10_model)) #quasi normal standard errors
summary(nba_10_model)
```

HFA seems to increase a teams strength parameter quite a lot (0.55495) with a high statistical significance from the null. That's about the difference between last place 30th Minnesota Timberwolves (-1.521) and the middle of the pack 14th Houston Rockets (0.069)

```{r initial_bt_plot}
nba_10_thetas.qv <- qvcalc(BTabilities(nba_10_model))$qvframe %>% #quasi normal standard errors
  rownames_to_column(var = "team")

nba_10_thetas.qv %>%
  ggplot(aes(x = reorder(as.factor(team), estimate), color = as.factor(team))) +
  geom_point(aes(y = estimate)) +
  geom_errorbar(aes(ymin = estimate - quasiSE, ymax = estimate + quasiSE)) + 
  coord_flip() + theme(legend.position = "none") + xlab("Team") + ylab(expression(theta))
```

Now, we try a margin of victory to predict $\theta_i$. In (2), $\delta_{i,j}$ represents the number of points $i$ (home) has over $j$ (away) and is negative if $j$ won. 

\begin{equation}
  \delta_{i,j} = \theta_i - \theta_j + \alpha
\end{equation}

Because the Bradley-Terry model works in the framework of a logistic regression, we must transform the margin of victory using the inverse of the logit (sigmoid) and feed that as the outcome in the Bradley-Terry model.

```{r}
sigmoid <- function(x) {
  exp(x)/(1 + exp(x))
}

nba_10_mov <- nba_10 %>%
  mutate(
    mov = home_score - away_score,
    sigmoid_mov = sigmoid(mov)
  )

nba_10_model_mov <- BTm(outcome = sigmoid_mov, #1 if player1 (home) wins and 0 if player2 (away) does
    player1 = data.frame(team = home, hfa = 1, days_since_last_game = home_days_since_last_game), 
    player2 = data.frame(team = away, hfa = 0, days_since_last_game = away_days_since_last_game),
    formula = ~team + hfa + days_since_last_game, id = "team", data = nba_10_mov)
```

Well... That doesn't work

